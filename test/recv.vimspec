Describe :ReplRecv
    Before each
        new!
    End

    After each
        call Cleanup()
    End

    It extracts user input from terminal window
        let b = bufnr('%')
        Repl node
        Assert True(WithTimeout(1, {-> getline('.') !=# ''}))
        execute bufwinnr(b) . 'wincmd w'

        call term_sendkeys(term_list()[0], "1 + 1\<CR>\<CR>1 +\<CR>1\<CR>")
        call WithTimeout(1, {-> len(getbufline(1, '$')) >= 7})

        ReplRecv

        let expected = [
            \   '',
            \   '1 + 1',
            \   '1 +',
            \   '1',
            \ ]
        Assert Equals(getline(1, '$'), expected)
    End

    It formats appended lines using `==`
        setlocal et tabstop=4 shiftwidth=4 softtabstop=4
        set ft=javascript
        let b = bufnr('%')
        Repl node
        Assert True(WithTimeout(1, {-> getline('.') !=# ''}))
        execute bufwinnr(b) . 'wincmd w'

        call term_sendkeys(term_list()[0], "function foo() {\<CR>return 'foo';\<CR>}\<CR>")
        call WithTimeout(1, {-> len(getbufline(1, '$')) >= 5})

        ReplRecv

        let expected = [
            \   '',
            \   'function foo() {',
            \   "    return 'foo';",
            \   '}',
            \ ]
        Assert Equals(getline(1, '$'), expected)
    End
End
